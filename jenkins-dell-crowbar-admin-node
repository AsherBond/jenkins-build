#!/bin/bash
#
# $1 = test repo number
#
env
# JENKINS COMMON
[ -e $(dirname $0)/jenkins-deb-common ] || exit 1
. $(dirname $0)/jenkins-deb-common
jenkins_init
jenkins_set_vars

# Hide ipmi info
source ~jenkins/.ipmirc

# SETUP ISO NAME
MILESTONE="d5"
if [ -z "$NOVA_RELEASE" ] || [ -z "$MILESTONE" ] || [ -z "$DISTRELEASE" ]; then
    ISONAME="crowbar.iso"
else
    BINARY_BUILD_RELEASE=`echo $DISTRELEASE | cut -d'-' -f2`
    ISONAME="crowbar-rcb-${NOVA_RELEASE}-${MILESTONE}-${BINARY_BUILD_RELEASE}.iso"
fi

# EXEC CROWBAR BUILD / BOOT ADMIN NODE
ssh openstack@${ISODEST} "sudo /home/openstack/incoming/fixup_crowbar.sh ${ISONAME}"
ssh openstack@${IPMIHOST} "ipmitool -I lanplus -H ${DRACIP} -U ${DRACUSER} -P ${DRACPASS} chassis bootdev pxe; ipmitool -I lanplus -H ${DRACIP} -U ${DRACUSER} -P ${DRACPASS} chassis power cycle"

# WAIT TO ENSURE TARGET GOES DOWN FOR REBOOT
sleep 120

# WAIT FOR ADMIN NODE TO HAVE SSH
while true; do nc -z 184.106.53.10 22 && break; echo 'Waiting for remote sshd...'; sleep 60; done

# SSH TO ADMIN NODE 
ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no crowbar@184.106.53.10 'export CROWBAR_KEY=`cat /etc/crowbar.install.key`; /opt/dell/bin/crowbar node_state status'
